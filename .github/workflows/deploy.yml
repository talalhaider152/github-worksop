name: CI + PR dev->main + Approval Ticket + Merge

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Deploy (Staging)
        run: echo "Deploy command here"

  create-pr-and-ticket:
    runs-on: ubuntu-latest
    needs: test-build-deploy

    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      issue_number: ${{ steps.issue.outputs.issue_number }}

    steps:
      - name: Create PR dev -> main (if not exists)
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Confirm dev branch exists
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: "dev" });
              core.info("dev branch exists");
            } catch (e) {
              core.setFailed("dev branch does not exist. Create it first.");
              return;
            }

            // Check if PR already exists dev -> main
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:dev`,
              base: "main",
              state: "open",
              per_page: 10
            });

            let pr;

            if (prs.length > 0) {
              pr = prs[0];
              core.info(`PR already exists: #${pr.number}`);
            } else {
              const bodyText =
                "âœ… CI passed\n" +
                "âœ… Deploy passed\n\n" +
                "Approval required via ticket comment:\n" +
                "Type **approve** / **approved** in the issue ticket to merge automatically.\n";

              const { data: newPr } = await github.rest.pulls.create({
                owner,
                repo,
                head: "dev",
                base: "main",
                title: "Auto PR: dev â†’ main",
                body: bodyText
              });

              pr = newPr;
              core.info(`PR created: #${pr.number}`);
            }

            core.setOutput("pr_number", String(pr.number));

      - name: Create Approval Issue Ticket
        id: issue
        uses: actions/github-script@v7
        env:
          APPROVER_GITHUB_USERNAME: ${{ secrets.APPROVER_GITHUB_USERNAME }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumberRaw = "${{ steps.pr.outputs.pr_number }}";
            const prNumber = Number(prNumberRaw);
            const approver = process.env.APPROVER_GITHUB_USERNAME;

            if (!prNumber) {
              core.setFailed("Missing PR number from previous step.");
              return;
            }

            if (!approver) {
              core.setFailed("Missing APPROVER_GITHUB_USERNAME secret.");
              return;
            }

            // Check if approval issue already exists for this PR
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: "approval-required",
              per_page: 100
            });

            const existing = issues.find(i => i.title.includes(`#${prNumber}`));

            if (existing) {
              core.info(`Approval issue already exists: #${existing.number}`);
              core.setOutput("issue_number", String(existing.number));
              return;
            }

            const prUrl = `https://github.com/${owner}/${repo}/pull/${prNumber}`;
            const issueBody =
              "ðŸš€ **Approval Ticket Created**\n\n" +
              `ðŸ”— PR Link: ${prUrl}\n\n` +
              "âœ… CI passed\n" +
              "âœ… Deploy passed\n\n" +
              `ðŸ‘¤ Approver: @${approver}\n\n` +
              "**How to Approve**\n" +
              "Comment on this issue with:\n\n" +
              "`approved` OR `approve`\n\n" +
              "Once approved, PR will merge automatically.\n";

            const { data: created } = await github.rest.issues.create({
              owner,
              repo,
              title: `Approval Required: Merge PR #${prNumber}`,
              body: issueBody,
              assignees: [approver],
              labels: ["approval-required"]
            });

            core.setOutput("issue_number", String(created.number));

  wait-for-approval-and-merge:
    runs-on: ubuntu-latest
    needs: create-pr-and-ticket

    steps:
      - name: Wait for Approval Comment and Merge
        uses: actions/github-script@v7
        env:
          APPROVER_GITHUB_USERNAME: ${{ secrets.APPROVER_GITHUB_USERNAME }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumber = Number("${{ needs.create-pr-and-ticket.outputs.pr_number }}");
            const issueNumber = Number("${{ needs.create-pr-and-ticket.outputs.issue_number }}");
            const approver = (process.env.APPROVER_GITHUB_USERNAME || "").toLowerCase();

            if (!prNumber || !issueNumber) {
              core.setFailed("Missing PR number or Issue number.");
              return;
            }

            if (!approver) {
              core.setFailed("Missing APPROVER_GITHUB_USERNAME secret.");
              return;
            }

            core.info(`Waiting for approval on issue #${issueNumber} for PR #${prNumber}. Approver: @${approver}`);

            const maxAttempts = 60; // 30 minutes
            const delayMs = 30000;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              core.info(`Attempt ${attempt}/${maxAttempts}`);

              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issueNumber,
                per_page: 100
              });

              const approved = comments.some(c => {
                const body = (c.body || "").trim().toLowerCase();
                const author = (c.user?.login || "").trim().toLowerCase();
                return (author === approver) && (body === "approved" || body === "approve");
              });

              if (approved) {
                core.info("Approval detected. Merging PR...");

                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prNumber,
                  merge_method: "squash"
                });

                core.info("PR merged successfully!");
                return;
              }

              await new Promise(r => setTimeout(r, delayMs));
            }

            core.setFailed("Approval not received in time.");
