name: CI + PR dev->main + Approval Ticket + Merge

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Deploy (Staging)
        run: echo "Deploy command here"

  create-pr-and-ticket:
    runs-on: ubuntu-latest
    needs: test-build-deploy

    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      issue_number: ${{ steps.issue.outputs.issue_number }}

    steps:
      - name: Create PR dev -> main (if not exists)
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // ‚úÖ Confirm dev branch exists
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: "dev" });
              core.info("‚úÖ dev branch exists");
            } catch (e) {
              core.setFailed("‚ùå dev branch does not exist. Create it first.");
              return;
            }

            // ‚úÖ Check if PR already exists dev -> main
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:dev`,
              base: "main",
              state: "open"
            });

            let pr;
            if (prs.length > 0) {
              pr = prs[0];
              core.info(`‚úÖ PR already exists: #${pr.number}`);
            } else {
              // ‚úÖ Create PR
              const { data: newPr } = await github.rest.pulls.create({
                owner,
                repo,
                head: "dev",
                base: "main",
                title: "Auto PR: dev ‚Üí main",
                body: `
            ‚úÖ CI passed  
            ‚úÖ Deploy passed  

            Approval required via ticket comment:
            Type **approve** / **approved** in the issue ticket to merge automatically.
                            `
                          });
                          pr = newPr;
                          core.info(`‚úÖ PR created: #${pr.number}`);
                        }

            core.setOutput("pr_number", pr.number);

      - name: Create Approval Issue Ticket
        id: issue
        uses: actions/github-script@v7
        env:
          APPROVER_GITHUB_USERNAME: ${{ secrets.APPROVER_GITHUB_USERNAME }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = Number("${{ steps.pr.outputs.pr_number }}");
            const approver = process.env.APPROVER_GITHUB_USERNAME;

            if (!approver) {
              core.setFailed("‚ùå Missing APPROVER_GITHUB_USERNAME secret.");
              return;
            }

            // ‚úÖ Check if approval issue already exists for this PR
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: "approval-required",
              per_page: 100
            });

            const existing = issues.find(i => i.title.includes(`#${prNumber}`));

            if (existing) {
              core.info(`‚úÖ Approval issue already exists: #${existing.number}`);
              core.setOutput("issue_number", existing.number);
              return;
            }

            const prUrl = `https://github.com/${owner}/${repo}/pull/${prNumber}`;

            const { data: issue } = await github.rest.issues.create({
              owner,
              repo,
              title: `Approval Required: Merge PR #${prNumber}`,
              body: `
            üöÄ **Approval Ticket Created**

            üîó PR Link: ${prUrl}

            üë§ Approver: @${approver}

            ‚úÖ CI passed  
            ‚úÖ Deploy passed  

            **How to Approve**
            Comment on this issue with:

            \`approved\` OR \`approve\`

            Once approved, PR will merge automatically.
                        `,
                        assignees: [approver],
                        labels: ["approval-required"]
                          });

                        core.setOutput("issue_number", issue.number);

        wait-for-approval-and-merge:
          runs-on: ubuntu-latest
          needs: create-pr-and-ticket

          steps:
            - name: Wait for Approval Comment and Merge
              uses: actions/github-script@v7
              env:
                APPROVER_GITHUB_USERNAME: ${{ secrets.APPROVER_GITHUB_USERNAME }}
              with:
                script: |
                  const owner = context.repo.owner;
                  const repo = context.repo.repo;
                  const prNumber = Number("${{ needs.create-pr-and-ticket.outputs.pr_number }}");
                  const issueNumber = Number("${{ needs.create-pr-and-ticket.outputs.issue_number }}");
                  const approver = (process.env.APPROVER_GITHUB_USERNAME || "").toLowerCase();

                  if (!prNumber || !issueNumber) {
                    core.setFailed("‚ùå Missing PR number or Issue number.");
                    return;
                  }

                  core.info(`Waiting for approval on issue #${issueNumber} for PR #${prNumber}`);

                  const maxAttempts = 60; // 30 min
                  const delayMs = 30000;

                  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    core.info(`Attempt ${attempt}/${maxAttempts}`);

                    const { data: comments } = await github.rest.issues.listComments({
                      owner,
                      repo,
                      issue_number: issueNumber,
                      per_page: 50
                    });

                    const approved = comments.some(c => {
                      const body = (c.body || "").trim().toLowerCase();
                      const author = (c.user?.login || "").trim().toLowerCase();

                      return (
                        (body === "approved" || body === "approve") &&
                        author === approver
                      );
                    });

                    if (approved) {
                      core.info("‚úÖ Approval detected. Merging PR...");

                      await github.rest.pulls.merge({
                        owner,
                        repo,
                        pull_number: prNumber,
                        merge_method: "squash"
                      });

                      core.info("üéâ PR merged successfully!");
                      return;
                    }

                    await new Promise(r => setTimeout(r, delayMs));
                  }

                  core.setFailed("‚ùå Approval not received in time.");
